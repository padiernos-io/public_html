<?php

/**
 * Fetch library mappings from the configuration.
 *
 * @return array
 *   An array of library mappings.
 */
function dynamic_library_loader_get_library_mappings() {
  $config = \Drupal::config('dynamic_library_loader.settings');
  $entries = $config->get('entries') ?? [];

  $library_mappings = [];
  foreach ($entries as $entry) {
    if (!empty($entry['enabled']) && !empty($entry['rows'])) {
      foreach ($entry['rows'] as $row) {
        $library_mappings[] = [
          'context_type' => $row['context_type'],
          'context' => $row['context'],
          'theme' => $row['theme'],
          'library' => $row['library'],
        ];
      }
    }
  }

  return $library_mappings;
}

/**
 * Implements hook_preprocess_node().
 */
function dynamic_library_loader_preprocess_node(&$variables) {
  $library_mappings = dynamic_library_loader_get_library_mappings();

  // Ensure we have a valid node object.
  if (!empty($variables['node'])) {
    $node = $variables['node'];
    $node_id = $node->id();
    $content_type = $node->bundle();

    // Iterate through mappings and attach libraries.
    foreach ($library_mappings as $mapping) {
      // Attach libraries for content types.
      if ($mapping['context_type'] === 'content_type' && $mapping['context'] === $content_type) {
        $variables['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
      }

      // Attach libraries for specific node IDs or multiple IDs.
      if ($mapping['context_type'] === 'node_id') {
        $node_ids = array_map('trim', explode(',', $mapping['context']));
        if (in_array((string) $node_id, $node_ids, TRUE)) {
          $variables['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_paragraph().
 */
function dynamic_library_loader_preprocess_paragraph(&$variables) {
  $library_mappings = dynamic_library_loader_get_library_mappings();

  if (!empty($variables['paragraph'])) {
    $paragraph = $variables['paragraph'];
    $paragraph_type = $paragraph->bundle();
    $paragraph_id = $paragraph->id();

    foreach ($library_mappings as $mapping) {

      // Attach libraries based on paragraph type.
      if ($mapping['context_type'] === 'paragraph_type' && $mapping['context'] === $paragraph_type) {
        $variables['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
      }

      // Attach libraries for specific paragraph IDs.
      if ($mapping['context_type'] === 'paragraph_id') {
        $paragraph_ids = array_map('trim', explode(',', $mapping['context']));
        if (in_array((string) $paragraph_id, $paragraph_ids, TRUE)) {
          $variables['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_block().
 */
function dynamic_library_loader_preprocess_block(&$variables) {
  $library_mappings = dynamic_library_loader_get_library_mappings();

  // Check if this is a custom block type.
  if (isset($variables['elements']['#base_plugin_id']) && $variables['elements']['#base_plugin_id'] === 'block_content') {
    // Retrieve the custom block type machine name.
    if (!empty($variables['elements']['content']['#block_content'])) {
      $block_content = $variables['elements']['content']['#block_content'];
      $block_type = $block_content->bundle();

      // Attach the library if it matches a mapping.
      foreach ($library_mappings as $mapping) {
        if ($mapping['context_type'] === 'block_type' && $mapping['context'] === $block_type) {
          $variables['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
        }
      }
    }
  }
}

/**
 * Implements hook_views_pre_render().
 */
function dynamic_library_loader_views_pre_render(\Drupal\views\ViewExecutable $view) {
  $library_mappings = dynamic_library_loader_get_library_mappings();

  // Attach libraries for views.
  foreach ($library_mappings as $mapping) {
    if ($mapping['context_type'] === 'view' &&
      ($mapping['context'] === $view->id() || $mapping['context'] === "{$view->id()}:{$view->current_display}")) {
      $view->element['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
    }
  }
}

/**
 * Implements hook_preprocess_taxonomy_term().
 */
function dynamic_library_loader_preprocess_taxonomy_term(&$variables) {
  $library_mappings = dynamic_library_loader_get_library_mappings();

  // Get the current taxonomy term details.
  $term = $variables['term'];
  $vocabulary = $term->bundle();

  // Iterate through the mappings and attach libraries based on context.
  foreach ($library_mappings as $mapping) {
    // Attach libraries for specific vocabularies.
    if ($mapping['context_type'] === 'taxonomy_term' && $mapping['context'] === $vocabulary) {
      $variables['#attached']['library'][] = "{$mapping['theme']}/{$mapping['library']}";
    }
  }
}